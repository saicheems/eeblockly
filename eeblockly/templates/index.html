<html>
<head>
  <meta charset="utf-8">
  <script src="https://unpkg.com/split.js/dist/split.min.js"></script>
  <script src="/static/js/blockly_compressed.js"></script>
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.css' rel='stylesheet'/>

  <link rel="stylesheet" href="static/css/style.css">
  <link rel="stylesheet" href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css">
</head>
<body>
  <div id="left-pane" class="split split-horizontal">
    <div id="map"></div>
  </div>
  <div id="right-pane" class="split split-horizontal">
    <div id="editor" class="split">
      <div id="editor-bar">
        <h1 class="label mdc-typography--headline6">Editor</h6>
        <button id="run-button" class="mdc-button mdc-button--outlined mdc-button--dense">Run</button>
      </div>
      <iframe id="blockly-area" class="split"></iframe>
    </div>
    <div id="console" class="split">
      <div id="console-bar">
        <h1 class="label mdc-typography--headline6">Console</h6>
      </div>
      <div id="console-entries">
        <p>> ...</p>
      </div>
    </div>
  </div>
  <div id="blockly-div" style="position: absolute;"></div>
  <xml id="toolbox" style="display: none">
    {% for group, blocks in groups|dictsort -%}
    <category name="{{group}}">
      {% for type, block in blocks|dictsort -%}
      <block type="{{type}}"></block>
      {%- endfor %}
    </category>
    {%- endfor %}
  </xml>
  <script>
    {%- autoescape false -%}
    {%- for group, blocks in groups|dictsort -%}
    {% for type, block in blocks|dictsort %}
    Blockly.Blocks["{{type}}"] = {
      init: function() {
        this.jsonInit({{json.dumps(block, sort_keys=True)}});
      }
    };
    {%- endfor %}
    {%- endfor %}
    {%- endautoescape %}
  </script>
  <script>
    var consoleEntries = document.getElementById("console-entries");
    document.getElementById("run-button").onclick = function() {
      var topBlocks = workspace.getTopBlocks();
      for (var i = 0; i < topBlocks.length; i++) {
        if (topBlocks[i].type == "Print") {
          var e = expression(topBlocks[i].inputList[0].connection.targetBlock());
          fetch('http://localhost:5000/v1/value:compute', {
            method: 'POST',
            body: JSON.stringify({'expression': e}),
            headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' }
          })
          .then(response => response.json())
          .catch(error => console.error(error))
          .then(response => {
            var p = document.createElement("p");
            var node = document.createTextNode("> " + JSON.stringify(response["result"]));
            p.appendChild(node);
            console.log(response);
            consoleEntries.append(p);
          });
        }
      }
    };
  </script>

  <script src="/static/js/init.js"></script>
  <script src="/static/js/build.js"></script>
</body>
</html>
